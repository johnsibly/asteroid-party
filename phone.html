<!DOCTYPE html>
<html>
<head>
  <title>Asteroid Party</title>
  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
    }
    body {
      background: #000;
      color: #FFF;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <canvas id="canvas" width="375" height="375"></canvas>
  <p id="latency"></p>
  <p id="highScore"></p>
  <button id="button_left" onmousedown="handleKeyOrMouseDown(37)">Left</button>
  <button id="button_right" onmousedown="handleKeyOrMouseDown(39)">Right</button>
  <button id="button_fire" onmousedown="handleKeyOrMouseDown(32)">Fire</button>
  <script type="text/javascript">
    document.getElementById("button_left").addEventListener("mousedown", e => handleKeyOrMouseDown(e, 37));
    document.getElementById("button_right").addEventListener("mousedown", e => handleKeyOrMouseDown(e, 39));
    document.getElementById("button_fire").addEventListener("mousedown", e => handleKeyOrMouseDown(e, 32));
    document.addEventListener('keydown', event => handleKeyOrMouseDown(event, event.keyCode));
    document.addEventListener('keyup', function(e) {
      e.preventDefault();
      socket.emit('stop');
    });
    const socket = io(),
      c=document.getElementById("canvas"),
      ctx=c.getContext("2d");
    ctx.strokeStyle = 'white';

    function handleKeyOrMouseDown(e, keyCode) {
      if (typeof e.preventDefault == 'function') { 
        e.preventDefault();
      }
      socket.emit('keydown', { keyCode: keyCode });
    }

    function getAngleOffset(direction, offset) {
      newDirection = direction + offset * Math.PI;
      while (newDirection > (2 * Math.PI)) {
        newDirection -= (2 * Math.PI);
      }
      return newDirection;
    }

    socket.on('move', function(state){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeRect(0, 0, canvas.width, canvas.height);

      state.players.forEach(player => {
        ctx.fillStyle = player.color;
        ctx.beginPath();

        const angle1 = player.direction;
        const angle2 = getAngleOffset(player.direction, 0.75);
        const angle3 = getAngleOffset(player.direction, 1.0);
        const angle4 = getAngleOffset(player.direction, 1.25);

        ctx.moveTo(player.x + 10 * Math.cos(angle1), player.y + 10 * Math.sin(angle1));
        ctx.lineTo(player.x + 10 * Math.cos(angle2), player.y + 10 * Math.sin(angle2));
        ctx.lineTo(player.x + 5 * Math.cos(angle3), player.y + 5 * Math.sin(angle3));
        ctx.lineTo(player.x + 10 * Math.cos(angle4), player.y + 10 * Math.sin(angle4));
        ctx.closePath();
        ctx.stroke();
        ctx.fill();

        if (player.bulletActive) {
          ctx.beginPath();
          ctx.arc(player.bulletX, player.bulletY, 3, 0, 2 * Math.PI);
          ctx.stroke();
        }
        if (player.color === '#000') { // ensure text is not black on black
          ctx.fillStyle = '#FFF';
        }
        const playerName = player.id === socket.id ? `${player.id.slice(0, 6)} - You` : player.id.slice(0, 6);
        ctx.fillText(`${playerName} [${player.score}]`, player.x, player.y - 20);
      });
      if (state.highScore.score > 0) {
        document.getElementById('latency').innerText = `High score: ${state.highScore.name} - ${state.highScore.score}`;
      }
    });

    socket.on('pong', (latency) => {
      const latencyString = `Latency ${latency} ms at ${new Date()}`
      console.log(latencyString);
      document.getElementById('latency').innerText = latencyString
    });

    socket.on('stop', function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    })
  </script>
</body>
</html>
